%% 此程序的主要功能是找到纤维束上脊髓上的椎节，脊髓从C1到C7会被SCT标记成
% 数字1~7 ，为了找到C6椎节，我们需要从下到上找到第一个为6的数字。将这一层标记出来作为mask. 
Names={
'S028'...
'S033'...
'S034'...
'S040'...
'S041'...
'S042'...
'S043'...
'S044'...
'S047'...
'S048'...
'S049'...
'S050'...
'S052'...
'S053'...
'S055'...
'S056'...
'S058'...
'S059'...
'S060'...
'S062'...
'S064'...
'S065'...
'S068'...
'S069'...
'S070'...
'S072'...
'S073'...
'S074'...
'S075'...
'S077'...
'S078'...
'S080'...
'S081'...
'S082'...
'S084'...
'S085'...
'S089'...
'S090'...
'S091'...
'S092'...
'S096'...
'S098'...
'S099'...
'S100'...
'S101'...
'S102'...
'S103'...
'S104'...
'S105'...
'S106'...
'S107'...
'S108'...
};
%'S037'...
spinalpoint=[];
brainpoint=[];
for a=1:length(Names)
filepath=['G:\Cortical_spinalcord\labeledImage\',Names{a},'_tha_Labeled.nii'];
    v=spm_vol(filepath);
    w=spm_read_vols(v);
    for z=1:37
      for j=1:192
        for i=1:192
            if w(i,j,z)==6000
                fprintf(['C6 mask is from NO.',num2str(z),'层\n']);
                spinalpoint(a,1)=z;
                return;
            end
        end    
      end
    end
    C6mask=w(:,:,z);
    C6mask=C6mask~=0;
    C6mask_v=v;
    C6mask_v.fname='G:\Cortical_spinalcord\S028\mask\C6mask.nii';
    C6mask_v.dim=[size(C6mask),1];
    spm_write_vol(C6mask_v,C6mask);
    %% 反变换回去的mask的最上层作为标准在个体间对齐，保证留下来的最大的部分是
    %皮质脊髓束，同时做一个水平面上的mask；
    %找到图像的最上层第一个不为0的地方，然后读取模板mask反变换回去个体的图像，截取这一层
    for z=70:-1:30
      for j=1:192
        for i=1:192
            if w(i,j,z)~=0
                fprintf(['Brain mask is from NO.',num2str(z),'层\n']);
                 brainpoint(a,1)=z;
                  break ;
            end
     
        end
      end
    end
    BrainPath='G:\Cortical_spinalcord\S028\Image\b0.nii';
    brain_v=spm_vol(BrainPath);
    brain_w=spm_read_vols(brain_v);
    BrainMask_w=brain_w(:,:,size(brain_w,3)-3);%3是mask的最顶层和整个脊髓大脑图像最顶端的差值；
    BrainMask_w=BrainMask_w~=0;
    BrainMask_v=v;
    BrainMask_v.fname='G:\Cortical_spinalcord\S028\mask\BrainMask.nii';
    BrainMask_v.dim=[size(BrainMask_w),1];
    spm_write_vol(BrainMask_v,BrainMask_w);
end

